<% content_for :title, "#{t('issues.page_title')} - #{@repository.full_name}" %>

<div class="min-h-full bg-gray-50 dark:bg-gray-900">
  <%= render 'shared/navbar' %>

  <div class="py-5">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mb-4">
      <%= render 'shared/flash_messages' %>
    </div>

    <header class="mb-8">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-2">
          <h1 class="text-2xl sm:text-3xl font-bold leading-tight tracking-tight text-gray-900 dark:text-white">
            <%= @repository.full_name %>
          </h1>
          <% if @search_mode == :local && @repository.stale? && @repository.cached_at.present? %>
            <div class="flex items-center gap-2">
              <div class="relative group">
                <%= button_to refresh_repository_issues_path(@repository), method: :post, params: (params[:q].present? ? { q: params[:q] } : {}), class: "inline-flex items-center p-2 text-yellow-600 dark:text-yellow-500 hover:text-emerald-600 dark:hover:text-emerald-500 transition-colors cursor-pointer" do %>
                  <!-- Warning icon - shown by default -->
                  <svg class="h-5 w-5 group-hover:hidden" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                  </svg>
                  <!-- Refresh icon - shown on hover -->
                  <svg class="h-5 w-5 hidden group-hover:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                <% end %>
                <!-- Tooltip with "Refresh" text on hover -->
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 text-xs font-medium text-white bg-gray-900 dark:bg-gray-700 rounded-md whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                  Refresh
                  <div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1">
                    <div class="border-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
                  </div>
                </div>
              </div>
              <span class="text-sm text-gray-500 dark:text-gray-400">
                Refreshed <%= time_ago_in_words(@repository.cached_at) %> ago
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </header>

    <main>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <%= form_with url: repository_issues_path(@repository), method: :get do |f| %>
          <!-- Search Bar -->
          <div class="flex gap-3 mb-4">
            <div class="flex-1 relative">
              <div class="grid grid-cols-1">
                <%= f.text_field :q,
                    value: @query,
                    placeholder: t('issues.index.search_placeholder'),
                    autocomplete: "off",
                    class: "col-start-1 row-start-1 block w-full rounded-md bg-white px-3 py-1.5 pr-10 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-emerald-600 dark:bg-white/5 dark:text-white dark:placeholder:text-gray-500 dark:outline-white/10 dark:focus:outline-emerald-500 sm:text-sm/6" %>
                <% if @query.present? %>
                  <%= link_to repository_issues_path(@repository, q: ""), class: "col-start-1 row-start-1 mr-3 size-5 self-center justify-self-end text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400" do %>
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
                    </svg>
                  <% end %>
                <% end %>
              </div>
            </div>
            <%= f.submit t('issues.index.search_button'), class: "inline-flex items-center px-4 py-[0.4375rem] border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 dark:bg-emerald-600 dark:hover:bg-emerald-700" %>
          </div>

        <% end %>

        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
          <!-- Filters Header Bar -->
          <div class="px-4 sm:px-6 py-3 border-b border-gray-200 dark:border-gray-700" data-controller="filters-toggle">
            <!-- Container uses flexbox wrapping to control layout -->
            <div class="flex flex-wrap items-center gap-3">
              <!-- State Filter Buttons (always first, flex-shrink-0 prevents wrapping) -->
              <div class="flex items-center gap-4 whitespace-nowrap">
                <%
                  query_text = @query || ""
                  has_state_open = query_text.match?(/\bstate:open\b|\bis:open\b/i)
                  has_state_closed = query_text.match?(/\bstate:closed\b|\bis:closed\b/i)

                  # Build query for open state
                  query_without_state = query_text.gsub(/\b(state|is):(open|closed)\b/i, '').gsub(/\s+/, ' ').strip
                  query_open = query_without_state.present? ? "state:open #{query_without_state}" : "state:open"
                  query_closed = query_without_state.present? ? "state:closed #{query_without_state}" : "state:closed"
                %>
                <%= link_to repository_issues_path(@repository, q: query_open), class: "text-sm font-medium whitespace-nowrap #{has_state_open ? 'text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" do %>
                  <%= "#{@open_count} " if @open_count %><%= t('issues.index.state_filter.open') %>
                <% end %>
                <%= link_to repository_issues_path(@repository, q: query_closed), class: "text-sm font-medium whitespace-nowrap #{has_state_closed ? 'text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" do %>
                  <%= "#{@closed_count} " if @closed_count %><%= t('issues.index.state_filter.closed') %>
                <% end %>
              </div>

              <!-- Mobile: Filters Toggle Button (on same row, right side) -->
              <div class="md:hidden ml-auto">
                <button type="button" class="inline-flex items-center gap-x-1.5 rounded-md bg-white dark:bg-gray-800 px-3 py-2 text-sm font-medium text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-200 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 whitespace-nowrap" data-action="click->filters-toggle#toggle">
                  Filters
                  <svg class="-mr-1 h-5 w-5 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" data-filters-toggle-target="icon">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>

              <!-- Desktop: Filter Dropdowns inline (on same row, right side) -->
              <div class="hidden md:flex md:flex-wrap md:items-center md:gap-2 md:ml-auto">
                <%= render partial: "filter_dropdowns", locals: { query_text: query_text } %>
              </div>
            </div>

            <!-- Mobile: Collapsible Filter Dropdowns (below top row, hidden by default) -->
            <div class="md:hidden mt-3 hidden" data-filters-toggle-target="mobileFilters">
              <div class="flex flex-wrap items-center gap-2">
                <%= render partial: "filter_dropdowns", locals: { query_text: query_text } %>
              </div>
            </div>
          </div>

          <div class="px-4 sm:px-6">
            <% if @issues.any? %>
              <div class="divide-y divide-gray-200 dark:divide-gray-700">
                <% @issues.each do |issue| %>
                  <%= render IssueCardComponent.new(issue: issue, repository: @repository) %>
                <% end %>
              </div>

              <!-- Pagination -->
              <% if @pagy && @pagy.pages > 1 %>
                <div class="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 px-4 py-3 sm:px-6 mt-4">
                  <div class="flex flex-1 justify-between sm:hidden">
                    <% if @pagy.prev %>
                      <%= link_to repository_issues_path(@repository, q: params[:q], page: @pagy.prev), class: "relative inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700" do %>
                        Previous
                      <% end %>
                    <% else %>
                      <span class="relative inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900 px-4 py-2 text-sm font-medium text-gray-400 dark:text-gray-500 cursor-not-allowed">Previous</span>
                    <% end %>
                    <% if @pagy.next %>
                      <%= link_to repository_issues_path(@repository, q: params[:q], page: @pagy.next), class: "relative ml-3 inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700" do %>
                        Next
                      <% end %>
                    <% else %>
                      <span class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900 px-4 py-2 text-sm font-medium text-gray-400 dark:text-gray-500 cursor-not-allowed">Next</span>
                    <% end %>
                  </div>
                  <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                    <div>
                      <p class="text-sm text-gray-700 dark:text-gray-300">
                        Showing
                        <span class="font-medium"><%= @pagy.from %></span>
                        to
                        <span class="font-medium"><%= @pagy.to %></span>
                        of
                        <span class="font-medium"><%= @pagy.count %></span>
                        results
                      </p>
                    </div>
                    <div>
                      <nav aria-label="Pagination" class="isolate inline-flex -space-x-px rounded-md shadow-sm">
                        <!-- Previous Button -->
                        <% if @pagy.prev %>
                          <%= link_to repository_issues_path(@repository, q: params[:q], page: @pagy.prev), class: "relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 dark:text-gray-500 ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-20 focus:outline-offset-0" do %>
                            <span class="sr-only">Previous</span>
                            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                              <path d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" fill-rule="evenodd" />
                            </svg>
                          <% end %>
                        <% else %>
                          <span class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 dark:text-gray-600 ring-1 ring-inset ring-gray-300 dark:ring-gray-600 cursor-not-allowed">
                            <span class="sr-only">Previous</span>
                            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                              <path d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" fill-rule="evenodd" />
                            </svg>
                          </span>
                        <% end %>

                        <!-- Page Numbers -->
                        <% @pagy.series.each do |item| %>
                          <% if item.is_a?(Integer) || item.is_a?(String) %>
                            <% page_num = item.to_i %>
                            <% if page_num == @pagy.page %>
                              <span aria-current="page" class="relative z-10 inline-flex items-center bg-emerald-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600"><%= page_num %></span>
                            <% else %>
                              <%= link_to page_num, repository_issues_path(@repository, q: params[:q], page: (page_num == 1 ? nil : page_num)), class: "relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-20 focus:outline-offset-0" %>
                            <% end %>
                          <% elsif item == :gap %>
                            <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-300 dark:ring-gray-600">...</span>
                          <% end %>
                        <% end %>

                        <!-- Next Button -->
                        <% if @pagy.next %>
                          <%= link_to repository_issues_path(@repository, q: params[:q], page: @pagy.next), class: "relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 dark:text-gray-500 ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-20 focus:outline-offset-0" do %>
                            <span class="sr-only">Next</span>
                            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                              <path d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                            </svg>
                          <% end %>
                        <% else %>
                          <span class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 dark:text-gray-600 ring-1 ring-inset ring-gray-300 dark:ring-gray-600 cursor-not-allowed">
                            <span class="sr-only">Next</span>
                            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                              <path d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                            </svg>
                          </span>
                        <% end %>
                      </nav>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white"><%= t('issues.index.empty.title') %></h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400"><%= t('issues.index.empty.description') %></p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
