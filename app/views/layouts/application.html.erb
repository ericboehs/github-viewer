<!DOCTYPE html>
<html class="h-full">
  <head>
    <title><%= content_for(:title) || t('app.title') %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Critical styles - load first to prevent flash %>
    <style>
      /* Remove all default outlines immediately */
      * {
        outline: none !important;
      }
    </style>

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "markdown", "data-turbo-track": "reload" %>
    <%# Tailwind CSS Play CDN %>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <%# Prism.js for syntax highlighting with GitHub theme %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/katorlys/prism-theme-github/themes/prism-theme-github-light.css" media="(prefers-color-scheme: light)">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/katorlys/prism-theme-github/themes/prism-theme-github-dark.css" media="(prefers-color-scheme: dark)">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup-templating.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-erb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-go.min.js"></script>
    <script>
      function highlightCodeBlocks() {
        // Wait for Prism to be available
        if (typeof Prism === 'undefined') {
          setTimeout(highlightCodeBlocks, 50);
          return;
        }

        document.querySelectorAll('.markdown pre code').forEach((block) => {
          // Skip if already highlighted by Prism (check for data attribute)
          if (block.hasAttribute('data-prism-highlighted')) return;

          // Get the language from the pre tag's lang attribute
          const pre = block.parentElement;
          let lang = pre.getAttribute('lang');

          // Remove commonmarker's span tags and get plain text
          const plainText = block.textContent;
          block.textContent = plainText;

          // Smart ERB detection
          const hasErbTags = plainText.includes('<' + '%') || plainText.includes('%' + '>');

          if (lang === 'ruby' && hasErbTags) {
            // Ruby code with ERB tags → use ERB
            lang = 'erb';
          } else if (lang === 'erb' && !hasErbTags) {
            // Marked as ERB but no ERB tags → fall back to ruby
            // (ERB highlighter can't highlight plain code)
            lang = 'ruby';
          }

          // Add language class if available
          if (lang) {
            block.className = `language-${lang}`;
          }

          // Highlight with Prism
          Prism.highlightElement(block);

          // Mark as highlighted
          block.setAttribute('data-prism-highlighted', 'true');
        });
      }

      // Clear highlighting markers before caching (for Turbo cache restoration)
      document.addEventListener('turbo:before-cache', () => {
        document.querySelectorAll('.markdown pre code').forEach((block) => {
          block.removeAttribute('data-prism-highlighted');
          block.className = '';  // Reset className so it gets recalculated from pre[lang]
        });
      });

      // Run on turbo:load (for turbo navigation)
      document.addEventListener('turbo:load', highlightCodeBlocks);

      // Also run when DOM is ready (for initial page load)
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', highlightCodeBlocks);
      } else {
        // DOM is already ready, run immediately
        highlightCodeBlocks();
      }
    </script>
    <style type="text/tailwindcss">
      @theme {
        --color-emerald-50: #ecfdf5;
        --color-emerald-100: #d1fae5;
        --color-emerald-200: #a7f3d0;
        --color-emerald-300: #6ee7b7;
        --color-emerald-400: #34d399;
        --color-emerald-500: #10b981;
        --color-emerald-600: #059669;
        --color-emerald-700: #047857;
        --color-emerald-800: #065f46;
        --color-emerald-900: #064e3b;
        --color-emerald-950: #022c22;
      }

      /* Global focus outline - use brand green */
      *:focus-visible {
        outline: 2px solid #10b981 !important;
        outline-offset: 2px !important;
      }

      /* Issue title links should have no outline (they use background color instead) */
      .issue-card a[href*='/issues/']:focus,
      .issue-card a[href*='/issues/']:focus-visible {
        outline: none !important;
      }

      /* Dropdown menu items should have no outline (they use background color instead) */
      [role="menu"] button:focus,
      [role="menu"] button:focus-visible,
      [role="menu"] a:focus,
      [role="menu"] a:focus-visible {
        outline: none !important;
      }

      /* Dark mode label styles - use transparent background algorithm */
      @media (prefers-color-scheme: dark) {
        /* Target label components by their unique class combination */
        .inline-flex.items-center.px-2.py-0\.5.rounded-full.text-xs.font-medium {
          background-color: rgba(var(--label-r), var(--label-g), var(--label-b), 0.18) !important;
          color: hsl(var(--label-h), var(--label-s), var(--label-l)) !important;
          border-color: hsla(var(--label-h), var(--label-s), var(--label-l), 0.3) !important;
        }
      }
    </style>
    <%= javascript_importmap_tags %>
  </head>

  <body class="h-full bg-white dark:bg-gray-900">
    <%= yield %>
  </body>
</html>
